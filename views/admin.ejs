<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Jadwal Pegawai</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    .navbar { background: #007BFF; color: #fff; padding: 10px 20px; display: flex; }
    .container { padding: 20px; }
    table { border-collapse: collapse; font-size: 14px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    th { background: #eee; position: sticky; top: 0; z-index: 1; }
    .left-table-wrapper, .right-table-wrapper { max-height: 500px; overflow: auto; }
    select, button { margin: 10px 5px; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }
    select { background: #fff; color: #000; border: 1px solid #ccc; font-weight: normal; }
    button { background: #28a745; color: #fff; }
    #message { margin-top: 10px; font-weight: bold; }
    #message.success { color: #28a745; }
    #message.fail { color: #dc3545; }
    
    .demand-table-container { 
      max-width: 600px;
      max-height: 300px;
      overflow: auto;
      margin-top: 25px; 
    }
    #demand-table select { margin: 2px; padding: 4px; }
    #demand-table td { vertical-align: middle; }
    
    #holiday-table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 14px; 
    }
    #holiday-table th, #holiday-table td { 
      border: 1px solid #ccc; 
      padding: 8px; 
      text-align: left; 
    }
    #holiday-table th { 
      background: #eee; 
      font-weight: bold; 
    }
    #newHolidayDate, #newHolidayName { 
      border: 1px solid #ccc; 
      border-radius: 4px; 
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 30px;
      border: 1px solid #888;
      border-radius: 8px;
      width: 500px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .modal-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .modal-body {
      margin-bottom: 20px;
      color: #333;
    }
    
    .modal-footer {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    .modal-btn {
      padding: 8px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .modal-btn-primary {
      background-color: #007bff;
      color: white;
    }
    
    .modal-btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .modal-btn-success {
      background-color: #28a745;
      color: white;
    }
    
    .modal-btn:hover {
      opacity: 0.8;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
  <div class="navbar">
    <div>Dashboard Admin</div>
  </div>
  <div class="container">
    <div>
      <label for="bulan">Bulan: </label>
      <select id="bulan" onchange="handleBulanChange()">
        <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
        <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
        <option value="7">Juli</option><option value="8">Agustus</option><option value="9" selected>September</option>
        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
      </select>
      
      <label style="margin-left: 15px; font-weight: normal; cursor: pointer;">
        <input type="checkbox" id="check-all" onchange="toggleAllChecks(this)" style="vertical-align: middle;">
        Centang Semua Action
      </label>
      <span id="message"></span>
    </div>
    <div style="display:flex; gap:20px; margin-top:15px;">
      <div class="left-table-wrapper">
        <table id="left-table">
          <thead>
            <tr>
              <th>NIP</th>
              <th>Nama</th>
              <th>Jenis</th>
              <th>Request</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="left-body"></tbody>
        </table>
      </div>
      <div class="right-table-wrapper">
        <table id="right-table">
          <thead id="right-head"></thead>
          <tbody id="right-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Below left table: Holiday table and Demand configuration side by side -->
    <div style="display:flex; gap:20px; margin-top:15px;">
      <div class="demand-table-container" style="flex: 1;">
        <h3 style="margin-bottom: 10px;">Tanggal Merah & Libur Bersama</h3>
        <div style="margin-bottom: 10px;">
          <input type="date" id="newHolidayDate" style="margin-right: 10px; padding: 6px;">
          <button onclick="addHoliday()" style="background:#28a745;">Tambah</button>
        </div>
        <table id="holiday-table">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="holiday-body"></tbody>
        </table>
      </div>

      <div class="demand-table-container" style="flex: 1;">
        <h3 style="margin-bottom: 10px;">Konfigurasi Demand Shift</h3>
        <table id="demand-table">
          <thead>
            <tr>
              <th>Shift</th>
              <th>Weekday</th>
              <th>Sabtu</th>
              <th>Minggu</th>
            </tr>
          </thead>
          <tbody id="demand-body"></tbody>
        </table>
      </div>
    </div>
    
    <div style="margin-top:15px;">
      <button onclick="generateJadwal()">Generate Jadwal</button>
      <button onclick="downloadExcel()" style="background:#6c757d;">Download Excel</button>
      <button id="pushToSheet" style="background:#0018F9;">Apply Jadwal Ke Sheet</button>
      <button onclick="resetPengajuan()" style="background:#dc3545;">Reset Pengajuan</button>
      <button id="undoResetBtn" onclick="undoReset()" style="background:#ffc107; color:#000; display:none;">Undo Reset</button>
      <button onclick="downloadRequestExcel()" style="background:#17a2b8;">Download Request</button>
    </div>
  </div>

  <!-- Modal for notifications -->
  <div id="notificationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalHeader">Notifikasi</div>
      <div class="modal-body" id="modalBody">Pesan akan muncul di sini</div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-primary" onclick="closeModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- Modal for confirmation -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="confirmHeader">Konfirmasi</div>
      <div class="modal-body" id="confirmBody">Apakah Anda yakin?</div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-danger" onclick="confirmAction()">Ya</button>
        <button class="modal-btn modal-btn-primary" onclick="cancelAction()">Tidak</button>
      </div>
    </div>
  </div>

  <script>
    let pegawaiTetap = [], dataPengajuan = [], pegawaiMap = {};
    let scheduleList = [];

    const scheduleColorMap = {
      'P6': '#FFF9C4', 'P7': '#FFF9C4', 'P8': '#FFF9C4', 'P9': '#FFF9C4',
      'P10': '#FFFF00', 'P11': '#FFECB3', 'S12': '#C8E6C9', 'SOCM': '#B2DFDB',
      'SOC2': '#B2DFDB', 'SOC6': '#B2DFDB', 'Libur': '#FFCDD2', 'Cuti': '#D1C4E9', 'M': '#E0E0E0',
    };

    const initialDemand = {
        'P6': {'Weekday': [2, 2], 'Sabtu': [2, 2], 'Minggu': [2, 2]},
        'P7': {'Weekday': [3, 3], 'Sabtu': [2, 2], 'Minggu': [1, 1]},
        'P8': {'Weekday': [3, 5], 'Sabtu': [2, 2], 'Minggu': [1, 1]},
        'P9': {'Weekday': [2, 4], 'Sabtu': [2, 2], 'Minggu': [1, 1]},
        'P10': {'Weekday': [2, 4], 'Sabtu': [0, 0], 'Minggu': [0, 0]},
        'P11': {'Weekday': [1, 1], 'Sabtu': [1, 1], 'Minggu': [1, 1]},
        'S12': {'Weekday': [4, 4], 'Sabtu': [3, 3], 'Minggu': [3, 3]},
        'M': {'Weekday': [2, 2], 'Sabtu': [2, 2], 'Minggu': [2, 2]},
        'SOCM': {'Weekday': [1, 1], 'Sabtu': [1, 1], 'Minggu': [1, 1]},
        'SOC2': {'Weekday': [1, 1], 'Sabtu': [1, 1], 'Minggu': [1, 1]},
        'SOC6': {'Weekday': [1, 1], 'Sabtu': [1, 1], 'Minggu': [1, 1]}
    };

    function daysInMonth(month, year) { return new Date(year, month, 0).getDate(); }
    function getTanggalBulan(bulan) {
      const yr = new Date().getFullYear();
      return Array.from({ length: daysInMonth(bulan, yr) }, (_, i) => `${String(i+1).padStart(2,'0')}-${String(bulan).padStart(2,'0')}-${yr}`);
    }

    function loadPegawai() {
      console.log('Loading pegawai data from database...');
      
      fetch('/api/pegawai')
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error loading pegawai:', data.error);
            alert('Gagal memuat data pegawai: ' + data.error);
            return;
          }
          
          pegawaiTetap = Array.isArray(data) ? data : [];
          pegawaiTetap.forEach(p => pegawaiMap[p.NIP] = p.Nama);
          renderRightTable();
          fetchPengajuan();
        })
        .catch(error => {
          console.error('Error fetching pegawai data:', error);
          alert('Gagal memuat data pegawai. Silakan refresh halaman.');
        });
    }
    function fetchPengajuan() {
      console.log('Loading pengajuan data from database...');
      
      fetch('/api/pengajuan')
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error loading pengajuan:', data.error);
            alert('Gagal memuat data pengajuan: ' + data.error);
            return;
          }
          
          dataPengajuan = Array.isArray(data) ? data : [];
          renderLeftTable();
          markSelectedDates();
        })
        .catch(error => {
          console.error('Error fetching pengajuan data:', error);
          alert('Gagal memuat data pengajuan. Silakan refresh halaman.');
        });
    }
    function renderLeftTable() {
      const tbody = document.getElementById('left-body');
      tbody.innerHTML = '';
      if (!dataPengajuan.length) {
        tbody.innerHTML = '<tr><td colspan="6">Tidak ada data pengajuan</td></tr>'; return;
      }
      dataPengajuan.forEach((p,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.nip}</td><td>${p.nama}</td><td>${p.jenis}</td><td>${p.request.join(', ')}</td><td>${p.status}</td><td><input type="checkbox" class="pengajuan-check" data-idx="${i}"></td>`;
        tbody.appendChild(tr);
      });
    }
    function renderRightTable() {
      const month = +document.getElementById('bulan').value;
      const days = getTanggalBulan(month);
      const thead = document.getElementById('right-head');
      const tbody = document.getElementById('right-body');
      thead.innerHTML = `<tr><th>NIP</th><th>Nama</th>` + days.map(d => `<th>${parseInt(d.split('-')[0],10)}</th>`).join('') + `</tr>`;
      tbody.innerHTML = '';
      pegawaiTetap.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.NIP}</td><td>${p.Nama}</td>` + days.map(d => `<td data-nip="${p.NIP}" data-tgl="${d}"></td>`).join('');
        tbody.appendChild(tr);
      });
      markSelectedDates();
    }
    function markSelectedDates() {
      document.querySelectorAll('#right-body td[data-tgl]').forEach(td => {
        td.textContent = ''; td.style.backgroundColor = '';
      });
      document.querySelectorAll('.pengajuan-check:checked').forEach(ch => {
        const p = dataPengajuan[+ch.dataset.idx];
        const isLibur = p.jenis.toLowerCase() === 'libur';
        const sym = isLibur ? 'LR' : 'C';
        const bg = isLibur ? scheduleColorMap['Libur'] : scheduleColorMap['Cuti'];
        p.request.forEach(tgl => {
          const cell = document.querySelector(`td[data-nip="${p.nip}"][data-tgl="${tgl}"]`);
          if (cell) { cell.textContent = sym; cell.style.backgroundColor = bg; }
        });
      });
    }
    document.getElementById('left-body').addEventListener('click', e => {
      if (e.target.matches('.pengajuan-check')) markSelectedDates();
    });
    function handleBulanChange() {
      renderRightTable();
      fetchPengajuan();
    }
    function toggleAllChecks(masterCheckbox) {
      const isChecked = masterCheckbox.checked;
      document.querySelectorAll('.pengajuan-check').forEach(checkbox => { checkbox.checked = isChecked; });
      markSelectedDates();
    }
    
    function renderDemandTable() {
      const tbody = document.getElementById('demand-body');
      tbody.innerHTML = '';

      const createDropdown = (selectedValue, max = 10) => {
          let options = '';
          for (let i = 0; i <= max; i++) {
              options += `<option value="${i}" ${i === selectedValue ? 'selected' : ''}>${i}</option>`;
          }
          return `<select>${options}</select>`;
      };

      for (const shift in initialDemand) {
          const tr = document.createElement('tr');
          tr.setAttribute('data-shift', shift);
          let cells = `<td>${shift}</td>`;
          
          for (const dayType of ['Weekday', 'Sabtu', 'Minggu']) {
              const value = initialDemand[shift][dayType];
              cells += '<td>';
              cells += createDropdown(value[0]);
              cells += ' - ';
              cells += createDropdown(value[1]);
              cells += '</td>';
          }
          tr.innerHTML = cells;
          tbody.appendChild(tr);
      }
    }

    function getDemandDataFromTable() {
      const demandData = {};
      const rows = document.querySelectorAll('#demand-body tr');

      rows.forEach(row => {
          const shift = row.dataset.shift;
          demandData[shift] = {};
          const cells = row.querySelectorAll('td');
          
          ['Weekday', 'Sabtu', 'Minggu'].forEach((dayType, i) => {
              const cell = cells[i + 1];
              const dropdowns = cell.querySelectorAll('select');
              demandData[shift][dayType] = [
                  parseInt(dropdowns[0].value, 10),
                  parseInt(dropdowns[1].value, 10)
              ];
          });
      });
      return demandData;
    }

        function generateJadwal() {
        const month = +document.getElementById('bulan').value;
        const year = new Date().getFullYear();
        const requests = [];
        document.querySelectorAll('.pengajuan-check:checked').forEach(ch => {
            const p = dataPengajuan[+ch.dataset.idx];
            p.request.forEach(tgl => {
                const [dd, mm, yyyy] = tgl.split('-');
                requests.push({ nip: Number(p.nip), jenis: p.jenis, tanggal: `${yyyy}-${mm}-${dd}` });
            });
        });

        if (!requests.length) {
            return alert('Pilih minimal satu pengajuan sebelum generate.');
        }
        
        const demandConfig = getDemandDataFromTable();

        alert('Mengambil data tanggal merah dan memulai proses generate...');

        // --- PERBAIKAN DIMULAI DI SINI ---
        // Ganti google.script.run dengan fetch ke API Anda sendiri
        fetch('/api/tanggal-merah')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Gagal mengambil data tanggal merah dari server.');
                }
                return response.json();
            })
            .then(holidaysFromServer => {
                // 'holidaysFromServer' adalah array tanggal merah dari backend Anda
                // Pastikan formatnya adalah array of strings ["YYYY-MM-DD", ...]
                const holidays = holidaysFromServer.map(h => h.tanggal.split('T')[0]);

                const payload = {
                    year,
                    month,
                    requests,
                    public_holidays: holidays,
                    demand: demandConfig
                };
                
                console.log("Payload yang dikirim ke API generate-schedule:", JSON.stringify(payload, null, 2));

                // Lanjutkan dengan mengirim payload ke API generate
                return fetch('http://localhost:5001/generate-schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            })
            .then(res => {
                if (!res.ok) {
                    // Coba baca pesan error dari server jika ada
                    return res.json().then(errData => {
                        throw new Error(errData.message || res.statusText);
                    });
                }
                return res.json();
            })
            .then(data => {
                alert(data.message || 'Proses pembuatan jadwal dimulai.');
                if (data.status_check_url) {
                    pollStatus(data.status_check_url);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Terjadi kesalahan: ' + err.message);
            });
        // --- AKHIR DARI PERBAIKAN ---
    }

    function pollStatus(checkUrl) {
      const interval = 10000, maxTries = 60; let tries = 0;
      const msgEl = document.getElementById('message');
      msgEl.textContent = 'Sedang memproses jadwal…';
      const timer = setInterval(() => {
        tries++;
        fetch(checkUrl)
          .then(res => { if (!res.ok) throw new Error(res.statusText); return res.json(); })
          .then(json => {
            console.log(json);
            if (json.state === 'SUCCESS' && Array.isArray(json.result) && json.result.length > 0) {
              clearInterval(timer);
              msgEl.textContent = `✅ Jadwal siap setelah ${tries} percobaan.`;
              msgEl.className = 'success';
              scheduleList = json.result.map(e => e.result);
              applyScheduleToMainTable(scheduleList[0].schedule);
            } else if (json.state === 'NO_SOLUTION') {
                clearInterval(timer); 
                msgEl.textContent = '❌ Proses selesai, namun tidak ada jadwal yang ditemukan.'; 
                msgEl.className = 'fail';
            } else if (tries >= maxTries) {
              clearInterval(timer); 
              msgEl.textContent = '❌ Batas polling terlampaui.'; 
              msgEl.className = 'fail';
            }
          })
          .catch(() => {
            if (tries >= maxTries) {
              clearInterval(timer); 
              msgEl.textContent = '❌ Polling gagal.'; 
              msgEl.className = 'fail';
            }
          });
      }, interval);
    }
    
    function applyScheduleToMainTable(scheduleData) {
      document.querySelectorAll('.auto-shift').forEach(c => {
        c.textContent = ''; c.style.backgroundColor = ''; c.classList.remove('auto-shift');
      });
      markSelectedDates();
      const month = String(document.getElementById('bulan').value).padStart(2, '0');
      const year = new Date().getFullYear();
      Object.entries(scheduleData).forEach(([nip, shifts]) => {
        shifts.forEach((shift, idx) => {
          const day = String(idx + 1).padStart(2, '0');
          const ddmmy = `${day}-${month}-${year}`;
          const cell = document.querySelector(`td[data-nip="${nip}"][data-tgl="${ddmmy}"]`);
          if (cell && !cell.textContent) {
            let display;
            // **PERUBAHAN KUNCI DI SINI**
            if (shift.toLowerCase() === 'libur') {
              display = 'L'; // Libur otomatis dari server = L
            } else if (shift.toLowerCase() === 'cuti') {
              display = 'C';
            } else {
              display = shift;
            }
            cell.textContent = display;
            cell.classList.add('auto-shift');
            const color = scheduleColorMap[shift];
            if (color) { cell.style.backgroundColor = color; } 
            else if (shift && shift !== '-') { cell.style.backgroundColor = '#e8f0fe'; }
          }
        });
      });
    }

    function downloadExcel() {
      const tbl = document.getElementById('right-table');
      if (!tbl) return alert('Tabel jadwal tidak ditemukan.');
      const header = Array.from(tbl.querySelectorAll('thead tr th')).map(th => th.textContent.trim());
      const bodyRows = Array.from(tbl.querySelectorAll('tbody tr'));
      const sheetData = [header];
      bodyRows.forEach(tr => {
        const rowData = Array.from(tr.querySelectorAll('td')).map(td => {
          const cellValue = td.textContent.trim();
          const cellObject = { v: cellValue, t: 's' };
          
          let colorKey = cellValue;
          if (cellValue === 'LR' || cellValue === 'L') {
              colorKey = 'Libur';
          } else if (cellValue === 'C') {
              colorKey = 'Cuti';
          }
          
          const colorHex = scheduleColorMap[colorKey];
          if (colorHex) {
            cellObject.s = { fill: { patternType: "solid", fgColor: { rgb: colorHex.replace('#', '') } } };
          }
          return cellObject;
        });
        sheetData.push(rowData);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(sheetData);
      const colWidths = header.map((_, i) => ({
        wch: Math.max(...sheetData.map(row => row[i] ? String(row[i].v).length : 0), header[i].length) + 2
      }));
      ws['!cols'] = colWidths;
      const monthName = document.getElementById('bulan').options[document.getElementById('bulan').selectedIndex].text;
      const year = new Date().getFullYear();
      XLSX.utils.book_append_sheet(wb, ws, 'Jadwal');
      XLSX.writeFile(wb, `Jadwal ${monthName} ${year}.xlsx`);
    }

    document.getElementById('pushToSheet').addEventListener('click', () => {
      const tbl = document.getElementById('right-table');
      if (!tbl) return alert('Jadwal belum ada. Generate dulu.');
      const allRows = Array.from(tbl.querySelectorAll('tr')).map(tr => Array.from(tr.children).map(cell => cell.textContent.trim()));
      
      google.script.run
        .withSuccessHandler(res => {
          if (res.success) { alert('✅ Jadwal berhasil ditulis ke sheet "JadwalOutput".'); } 
          else { alert('❌ Gagal: ' + res.message); }
        })
        .withFailureHandler(err => { alert('❌ Server error: ' + err.message); })
        .writeScheduleToSheet(allRows);
    });

    // Reset pengajuan function
    function resetPengajuan() {
      showConfirmModal(
        'Konfirmasi Reset', 
        'Apakah Anda yakin ingin mereset pengajuan? Jatah cuti CAP dan libur akan dikembalikan ke full, tapi cuti tahunan tidak akan berubah.',
        () => {
          console.log('Resetting pengajuan...');
          fetch('/api/reset-pengajuan', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
          })
          .then(response => {
            console.log('Reset response status:', response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Reset response data:', data);
            if (data.success) {
              // Store backup data for potential undo
              lastResetBackup = data.backupData;
              showModal('Berhasil', data.message + ' (Undo tersedia)');
              fetchPengajuan(); // Refresh data
              updateUndoButton(); // Show undo button
            } else {
              showModal('Error', 'Gagal reset pengajuan: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error resetting pengajuan:', error);
            showModal('Error', 'Server error: ' + error.message);
          });
        }
      );
    }

    // Undo reset function
    function undoReset() {
      if (!lastResetBackup) {
        showModal('Peringatan', 'Tidak ada data backup untuk di-undo.');
        return;
      }

      showConfirmModal(
        'Konfirmasi Undo', 
        'Apakah Anda yakin ingin mengembalikan pengajuan yang telah direset?',
        () => {
          console.log('Undoing reset...');
          fetch('/api/undo-reset-pengajuan', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ backupData: lastResetBackup })
          })
          .then(response => {
            console.log('Undo response status:', response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Undo response data:', data);
            if (data.success) {
              showModal('Berhasil', data.message);
              fetchPengajuan(); // Refresh data
              lastResetBackup = null; // Clear backup
              updateUndoButton(); // Hide undo button
            } else {
              showModal('Error', 'Gagal undo reset: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error undoing reset:', error);
            showModal('Error', 'Server error: ' + error.message);
          });
        }
      );
    }

    // Update undo button visibility
    function updateUndoButton() {
      const undoButton = document.getElementById('undoResetBtn');
      if (undoButton) {
        undoButton.style.display = lastResetBackup ? 'inline-block' : 'none';
      }
    }

    // Download request Excel function
    function downloadRequestExcel() {
      if (!dataPengajuan.length) {
        return alert('Tidak ada data pengajuan untuk didownload.');
      }
      
      const header = ['NIP', 'Nama', 'Jenis', 'Tanggal Request', 'Status'];
      const sheetData = [header];
      
      dataPengajuan.forEach(p => {
        const rowData = [
          p.nip,
          p.nama,
          p.jenis,
          p.request.join(', '),
          p.status
        ];
        sheetData.push(rowData);
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(sheetData);
      
      // Set column widths
      const colWidths = [
        { wch: 15 }, // NIP
        { wch: 25 }, // Nama
        { wch: 15 }, // Jenis
        { wch: 30 }, // Tanggal Request
        { wch: 15 }  // Status
      ];
      ws['!cols'] = colWidths;
      
      const monthName = document.getElementById('bulan').options[document.getElementById('bulan').selectedIndex].text;
      const year = new Date().getFullYear();
      XLSX.utils.book_append_sheet(wb, ws, 'Request Pengajuan');
      XLSX.writeFile(wb, `Request Pengajuan ${monthName} ${year}.xlsx`);
    }

    // Holiday management functions
    let holidayData = [];
    let pendingAction = null;
    let lastResetBackup = null; // Store backup data for undo

    // Modal functions
    function showModal(title, message, type = 'info') {
      document.getElementById('modalHeader').textContent = title;
      document.getElementById('modalBody').textContent = message;
      document.getElementById('notificationModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('notificationModal').style.display = 'none';
    }

    function showConfirmModal(title, message, action) {
      document.getElementById('confirmHeader').textContent = title;
      document.getElementById('confirmBody').textContent = message;
      pendingAction = action;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function confirmAction() {
      if (pendingAction) {
        pendingAction();
        pendingAction = null;
      }
      document.getElementById('confirmModal').style.display = 'none';
    }

    function cancelAction() {
      pendingAction = null;
      document.getElementById('confirmModal').style.display = 'none';
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const notificationModal = document.getElementById('notificationModal');
      const confirmModal = document.getElementById('confirmModal');
      if (event.target === notificationModal) {
        closeModal();
      }
      if (event.target === confirmModal) {
        cancelAction();
      }
    }

    function loadHolidays() {
      console.log('Loading holidays data from database...');
      
      // Clear existing data first
      holidayData = [];
      renderHolidayTable();
      
      fetch('/api/tanggal-merah')
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Holidays data received:', data);
          if (data.error) {
            console.error('Error loading holidays:', data.error);
            showModal('Error', 'Gagal memuat data tanggal merah: ' + data.error);
            return;
          }
          
          holidayData = Array.isArray(data) ? data : [];
          console.log('Setting holidayData to:', holidayData);
          renderHolidayTable();
        })
        .catch(error => {
          console.error('Error fetching holidays data:', error);
          showModal('Error', 'Gagal memuat data tanggal merah: ' + error.message);
        });
    }

    function renderHolidayTable() {
      const tbody = document.getElementById('holiday-body');
      tbody.innerHTML = '';
      
      console.log('Rendering holiday table with data:', holidayData);
      
      if (!holidayData.length) {
        tbody.innerHTML = '<tr><td colspan="2">Tidak ada tanggal merah</td></tr>';
        return;
      }
      
      holidayData.forEach((holiday, index) => {
        const tr = document.createElement('tr');
        // Format date to DD-MM-YYYY for display
        const date = new Date(holiday.tanggal);
        const formattedDate = date.toLocaleDateString('id-ID', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
        
        tr.innerHTML = `
          <td>${formattedDate}</td>
          <td>
            <button onclick="deleteHoliday(${index})" style="background:#dc3545; padding: 4px 8px; font-size: 12px;">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function addHoliday() {
      const dateInput = document.getElementById('newHolidayDate').value;
      
      if (!dateInput) {
        showModal('Peringatan', 'Mohon isi tanggal hari libur.');
        return;
      }
      
      // Use the date input directly (it's already in YYYY-MM-DD format)
      const formattedDate = dateInput;
      
      console.log('Date input:', dateInput);
      console.log('Formatted date:', formattedDate);
      
      // Check if date already exists
      if (holidayData.some(h => h.tanggal === formattedDate)) {
        showModal('Peringatan', 'Tanggal ini sudah ada dalam daftar.');
        return;
      }
      
      console.log('Adding holiday with date:', formattedDate);
      fetch('/api/tanggal-merah', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({ tanggal: formattedDate })
      })
      .then(response => {
        console.log('Add response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Add response data:', data);
        if (data.success) {
          showModal('Berhasil', 'Tanggal merah berhasil ditambahkan.');
          document.getElementById('newHolidayDate').value = '';
          loadHolidays(); // Refresh table
        } else {
          showModal('Error', 'Gagal menambahkan tanggal merah: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error adding holiday:', error);
        showModal('Error', 'Server error: ' + error.message);
      });
    }

    function deleteHoliday(index) {
      const holiday = holidayData[index];
      console.log('Holiday to delete:', holiday);
      
      // Use the original date from database (should be in YYYY-MM-DD format)
      let dbDate = holiday.tanggal;
      
      // Ensure the date is in YYYY-MM-DD format
      if (dbDate && typeof dbDate === 'string') {
        // If it has timezone info, extract just the date part
        if (dbDate.includes('T')) {
          dbDate = dbDate.split('T')[0];
        }
        // If it's already in YYYY-MM-DD format, use it directly
      } else {
        showModal('Error', 'Data tanggal tidak valid');
        return;
      }
      
      console.log('Date to delete (normalized):', dbDate);
      
      // Format for display
      const displayDate = new Date(dbDate).toLocaleDateString('id-ID', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      
      showConfirmModal(
        'Konfirmasi Hapus', 
        `Hapus tanggal merah pada ${displayDate}?`,
        () => {
          console.log('Deleting holiday with date:', dbDate);
          fetch('/api/tanggal-merah', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ tanggal: dbDate })
          })
          .then(response => {
            console.log('Delete response status:', response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Delete response data:', data);
            if (data.success) {
              showModal('Berhasil', 'Tanggal merah berhasil dihapus.');
              loadHolidays(); // Refresh table
            } else {
              showModal('Error', 'Gagal menghapus tanggal merah: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error deleting holiday:', error);
            showModal('Error', 'Server error: ' + error.message);
          });
        }
      );
    }

    // Test DELETE method
    function testDelete() {
      console.log('Testing DELETE method...');
      fetch('/api/test-delete', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ test: 'data' })
      })
      .then(response => {
        console.log('Test DELETE response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Test DELETE response data:', data);
      })
      .catch(error => {
        console.error('Test DELETE error:', error);
      });
    }

    // Test database connection
    function testDatabase() {
      console.log('Testing database connection...');
      fetch('/api/test-db')
      .then(response => {
        console.log('Test DB response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Test DB response data:', data);
      })
      .catch(error => {
        console.error('Test DB error:', error);
      });
    }

    // Test getting holidays
    function testGetHolidays() {
      console.log('Testing get holidays...');
      fetch('/api/tanggal-merah')
      .then(response => {
        console.log('Get holidays response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Get holidays response data:', data);
      })
      .catch(error => {
        console.error('Get holidays error:', error);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadPegawai();
      renderDemandTable();
      loadHolidays();
      
      // Test methods on page load
      setTimeout(() => {
        testDatabase();
        testGetHolidays();
        testDelete();
      }, 2000);
    });
  </script>
</body>
</html>