<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Form Pengajuan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
  

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <style>
    /* === GAYA DASAR (UNTUK DESKTOP & LAYAR BESAR) === */
    body {
      display: flex;
      flex-direction: column;
      margin: 0;
      min-height: 100vh;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      font-size: 16px;
      overflow-x: hidden;
    }

    /* TOP BAR (NAVBAR) */
    .top-bar {
      width: 100%;
      background-color: #f8f8f8;
      padding: 18px 35px;
      border-bottom: 2px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-sizing: border-box;
    }
    .top-bar a {
      font-size: 18px;
      font-weight: 500;
      color: #d80000;
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: color .2s;
    }
    .top-bar a:hover { color: #a80000; }
    .top-bar .material-icons-outlined {
      font-size: 28px;
      margin-right: 10px;
    }

    /* DROPDOWN MENU */
    .dropdown { position: relative; display: inline-block; }
    .dropdown .dropdown-toggle { cursor: pointer; }
    #userNipDisplay { margin: 0 8px; }
    .dropdown-menu {
      display: none; position: absolute; right: 0; background-color: #ffffff;
      min-width: 220px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
      border-radius: 8px; z-index: 100; margin-top: 10px; overflow: hidden;
    }
    .dropdown-menu a { color: #333; padding: 15px 20px; font-size: 16px; }
    .dropdown-menu a:hover { background-color: #f1f1f1; }
    .dropdown-menu.show { display: block; }

    /* KONTEN UTAMA & FORM */
    .content { flex: 1; overflow-y: auto; padding: 30px; }
    .form-container {
      background: white; max-width: 1000px; margin: 0 auto; padding: 30px;
      border-radius: 12px; box-shadow: 0 0 12px rgba(0, 0, 0, 0.12);
    }

    h2 { font-size: 30px; margin-bottom: 30px; }
    h3 { font-size: 24px; }
    h2, h3 { text-align: center; color: #000000; }

    label {
      display: block; margin-top: 25px; font-weight: bold;
      font-size: 18px; margin-bottom: 12px;
    }
    #labelLibur { margin-bottom: 20px; }

    .form-container input {
      width: 100%; padding: 14px 18px; font-size: 16px; font-style: italic;
      margin-top: 8px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;
    }

    button[type="submit"] {
      margin-top: 40px; background-color: #d80000; color: white; font-weight: bold;
      border: none; cursor: pointer; font-size: 18px; padding: 15px 30px;
      border-radius: 10px; transition: all 0.3s ease; display: block;
      width: 100%; max-width: 320px; margin-left: auto; margin-right: auto;
    }
    button[type="submit"]:hover {
      background-color: #a80000; transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* RIWAYAT */
    .riwayat-container {
      background: white; max-width: 1000px; margin: 0 auto 30px auto;
      padding: 30px 25px; border-radius: 12px; box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
    }
    #riwayat-section h2 { margin-top: 50px; margin-bottom: 25px !important; }
    .riwayat-container table {
      width: 100%; border-collapse: collapse; border-radius: 10px;
      overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .riwayat-container th, .riwayat-container td {
      border: 1px solid #ddd; padding: 14px 16px;
      text-align: center; white-space: nowrap;
    }
    .riwayat-container th {
      background-color: #f9f9f9; color: #d80000; font-weight: bold;
      font-size: 16px;
    }
    .riwayat-container td { font-size: 15px; color: #333; }
    .riwayat-container h3 { font-size: 22px; color: #d80000; margin-bottom: 20px; }
    .riwayat-container tr:nth-child(even) td { background-color: #f7f7f7; }
  
    /* MODAL (TETAP SAMA) */
    .custom-modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
    .custom-modal.show { display: flex; }
    .custom-modal-content { background: #fff; padding: 0; border-radius: 16px; width: 400px; max-width: 90%; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease; overflow: hidden; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-50px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .custom-modal-header { color: white; padding: 20px 25px; text-align: center; position: relative; }
    .custom-modal-header.success { background: linear-gradient(135deg, #28a745, #20c997); }
    .custom-modal-header.error { background: linear-gradient(135deg, #dc3545, #fd7e14); }
    .custom-modal-header.warning { background: linear-gradient(135deg, #ffc107, #fd7e14); }
    .custom-modal-header.info { background: linear-gradient(135deg, #17a2b8, #6f42c1); }
    .custom-modal-header.logout { background: linear-gradient(135deg, #d80000, #ff4444); }
    .custom-modal-header h3 { margin: 0; font-size: 20px; font-weight: 600; }
    .custom-modal-icon .material-icons-outlined { font-size: 48px !important; color: white !important; margin-right: 0; }
    .custom-modal-body { padding: 25px; text-align: center; }
    .custom-modal-message { font-size: 16px; color: #333; line-height: 1.5; margin-bottom: 25px; }
    .custom-modal-buttons { display: flex; gap: 12px; justify-content: center; }
    .custom-modal-btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-width: 100px; }
    .custom-modal-btn-cancel { background: #f8f9fa; color: #6c757d; border: 2px solid #e9ecef; }
    .custom-modal-btn-cancel:hover { background: #e9ecef; border-color: #dee2e6; transform: translateY(-1px); }
    .custom-modal-btn-confirm { background: linear-gradient(135deg, #d80000, #ff4444); color: white; border: 2px solid #d80000; }
    .custom-modal-btn-confirm:hover { background: linear-gradient(135deg, #b30000, #e63939); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(216, 0, 0, 0.3); }
    .custom-modal-btn-success { background: linear-gradient(135deg, #28a745, #20c997); color: white; border: 2px solid #28a745; }
    .custom-modal-btn-success:hover { background: linear-gradient(135deg, #218838, #1e7e34); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }

    /* === MOBILE RESPONSIVE STYLES (UNTUK LAYAR DI BAWAH 768px) === */
    @media (max-width: 768px) {
      body { display: block; height: auto; }
      
      /* PERBAIKAN: Navbar dikecilkan untuk HP */
      .top-bar { padding: 12px 15px; }
      .top-bar a { font-size: 14px !important; }
      .top-bar .material-icons-outlined { font-size: 22px !important; }
      /* PERBAIKAN: NIP ditampilkan kembali tapi fontnya dikecilkan agar muat */
      #userNipDisplay { font-size: 14px; } 

      .content { padding: 15px; }
      .form-container { padding: 20px; }
      
      /* PERBAIKAN: Ukuran font konten dikecilkan untuk HP */
      h2 { font-size: 22px !important; }
      h3 { font-size: 19px !important; }
      label { font-size: 16px; }
      .form-container input { font-size: 15px; padding: 12px 15px; }
      button[type="submit"] { font-size: 16px; padding: 14px 28px; }

      .riwayat-container { overflow-x: auto; padding: 15px; }
      .riwayat-container h3 { font-size: 20px; }
      .riwayat-container th { font-size: 14px; padding: 10px; }
      .riwayat-container td { font-size: 13px; padding: 10px; }

      .custom-modal-content { width: 95%; margin: 20px; }
      .custom-modal-buttons { flex-direction: column; }
      .custom-modal-btn { width: 100%; }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <a id="goToPengajuanUlang" href="/pengajuan-ulang">
      <span class="material-icons-outlined">edit_calendar</span>
      Pengajuan Ulang
    </a>
    <div class="dropdown">
      <a id="userDropdownToggle" class="dropdown-toggle">
        <span class="material-icons-outlined">account_circle</span>
        <span id="userNipDisplay"><%= user.nip %></span>
        <span class="material-icons-outlined">arrow_drop_down</span>
      </a>
      <div id="userDropdownMenu" class="dropdown-menu">
        <a id="logoutLink" href="/logout">
          <span class="material-icons-outlined">logout</span> Logout
        </a>
      </div>
    </div>
  </div>

  <div class="content">
    <h2>Form Pengajuan</h2>

    <div class="form-container">
      <form method="POST" action="/form">
        <h3>Pengajuan Libur</h3>
        <label id="labelLibur">Sisa request Libur: <%= data.jatah.liburTersisa %></label>
        
        <div id="tanggalLiburContainer">
          <% if (data.jatah.liburTersisa <= 0) { %>
            <input type="text" placeholder="Jatah libur sudah habis" disabled style="background-color: #f5f5f5; color: #999; cursor: not-allowed;" />
          <% } %>
        </div>
        <input type="hidden" name="jumlahLibur" value="<%= data.jatah.liburTersisa > 0 ? data.jatah.liburTersisa : 0 %>">

        <h3>Pengajuan Cuti Tahunan</h3>
        <label id="labelCuti">Sisa Cuti Tahunan: <%= data.jatah.cutiTersisa %></label>
        <% if (data.jatah.cutiTersisa > 0) { %>
          <input type="number" id="jumlahCuti" name="jumlahCuti" min="0" max="<%= data.jatah.cutiTersisa %>" placeholder="Masukkan jumlah cuti tahunan" />
          <div id="tanggalCutiContainer"></div>
        <% } else { %>
          <input type="text" placeholder="Jatah cuti tahunan sudah habis" disabled style="background-color: #f5f5f5; color: #999; cursor: not-allowed;" />
        <% } %>

        <h3>Pengajuan Cuti CAP</h3>
        <label id="labelCutiLain">Sisa Cuti CAP: <%= data.jatah.cutiLainTersisa %></label>
        <% if (data.jatah.cutiLainTersisa > 0) { %>
          <input type="number" id="jumlahCutiLain" name="jumlahCutiLain" min="0" max="<%= data.jatah.cutiLainTersisa %>" placeholder="Masukkan jumlah cuti CAP" />
          <div id="tanggalCutiLainContainer"></div>
        <% } else { %>
          <input type="text" placeholder="Jatah cuti CAP sudah habis" disabled style="background-color: #f5f5f5; color: #999; cursor: not-allowed;" />
        <% } %>

        <center><button type="submit">Ajukan</button></center>
      </form>
    </div>

    <div id="riwayat-section">
      <h2>Riwayat Pengajuan</h2>
      <div class="riwayat-container">
        <h3>Libur</h3>
        <table>
          <thead><tr><th>No</th><th>Tanggal</th></tr></thead>
          <tbody>
            <% data.pengajuan.libur.forEach((tgl, i) => { %>
              <tr><td><%= i + 1 %></td><td><%= tgl %></td></tr>
            <% }) %>
            <% if (data.pengajuan.libur.length === 0) { %>
              <tr><td colspan="2">Tidak ada riwayat</td></tr>
            <% } %>
          </tbody>
        </table>

        <h3>Cuti Tahunan</h3>
        <table>
          <thead><tr><th>No</th><th>Tanggal</th></tr></thead>
          <tbody>
            <% data.pengajuan.cuti.forEach((tgl, i) => { %>
              <tr><td><%= i + 1 %></td><td><%= tgl %></td></tr>
            <% }) %>
             <% if (data.pengajuan.cuti.length === 0) { %>
              <tr><td colspan="2">Tidak ada riwayat</td></tr>
            <% } %>
          </tbody>
        </table>

        <h3>Cuti CAP</h3>
        <table>
          <thead><tr><th>No</th><th>Tanggal</th></tr></thead>
          <tbody>
            <% data.pengajuan.cutiLain.forEach((tgl, i) => { %>
              <tr><td><%= i + 1 %></td><td><%= tgl %></td></tr>
            <% }) %>
            <% if (data.pengajuan.cutiLain.length === 0) { %>
              <tr><td colspan="2">Tidak ada riwayat</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="customModal" class="custom-modal">
    <div class="custom-modal-content">
      <div id="modalHeader" class="custom-modal-header">
        <div id="modalIcon" class="custom-modal-icon"></div>
        <h3 id="modalTitle">Konfirmasi</h3>
      </div>
      <div class="custom-modal-body">
        <div id="modalMessage" class="custom-modal-message">Apakah Anda yakin?</div>
        <div id="modalButtons" class="custom-modal-buttons">
          <button id="modalCancelBtn" class="custom-modal-btn custom-modal-btn-cancel" onclick="hideCustomModal()">Batal</button>
          <button id="modalConfirmBtn" class="custom-modal-btn custom-modal-btn-confirm" onclick="confirmCustomModal()">Ya</button>
        </div>
      </div>
    </div>
  </div>

  <div id="server-data" style="display:none;" 
       data-disable-dates-libur='<%- JSON.stringify(data.disableDatesLibur || []) %>'
       data-libur-tersisa="<%= data.jatah.liburTersisa %>"
       data-cuti-tersisa="<%= data.jatah.cutiTersisa %>"
       data-cutilain-tersisa="<%= data.jatah.cutiLainTersisa %>">
  </div>
  
  <% if (typeof status !== 'undefined' && message) { %>
    <div id="server-message-data" style="display:none;" data-status="<%= status %>">
        <%- message %>
    </div>
  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <script>
    // --- FUNGSI-FUNGSI UTAMA (TIDAK ADA EJS DI SINI) ---
    function createDatePickers(jumlah, containerId, namePrefix, disableDates, isLibur = false) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      for (let i = 1; i <= jumlah; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.name = `${namePrefix}_tanggal${i}`;
        input.placeholder = `Pilih Tanggal ${i}`;
        input.required = true;
        container.appendChild(input);

        let config = {
          dateFormat: "Y-m-d",
          minDate: "today"
        };
        
        if (isLibur) {
          config.disable = disableDates;
        }

        flatpickr(input, config);
      }
    }

    let currentModalCallback = null;
    function showCustomModal(options) {
      const modal = document.getElementById('customModal');
      const header = document.getElementById('modalHeader');
      const iconEl = document.getElementById('modalIcon');
      const title = document.getElementById('modalTitle');
      const message = document.getElementById('modalMessage');
      const confirmBtn = document.getElementById('modalConfirmBtn');
      const cancelBtn = document.getElementById('modalCancelBtn');
      
      const icons = {
          success: 'check_circle', error: 'error', warning: 'warning',
          info: 'info', logout: 'logout'
      };
      
      const iconName = icons[options.type] || 'help_outline';
      
      iconEl.innerHTML = `<span class="material-icons-outlined">${iconName}</span>`;
      title.textContent = options.title || 'Konfirmasi';
      message.innerHTML = options.message || 'Apakah Anda yakin?'; 
      confirmBtn.textContent = options.confirmText || 'Ya';
      
      header.className = `custom-modal-header ${options.type || 'info'}`;
      confirmBtn.className = `custom-modal-btn ${options.type === 'success' ? 'custom-modal-btn-success' : 'custom-modal-btn-confirm'}`;
      
      currentModalCallback = options.onConfirm || null;
      cancelBtn.style.display = (options.showCancel === false) ? 'none' : 'flex';
      modal.classList.add('show');
    }

    function hideCustomModal() {
      document.getElementById('customModal').classList.remove('show');
      currentModalCallback = null;
    }

    function confirmCustomModal() {
      if (currentModalCallback) {
        currentModalCallback();
      }
      hideCustomModal();
    }
    
    // --- LOGIKA UTAMA SETELAH HALAMAN SIAP ---
    document.addEventListener('DOMContentLoaded', function() {
      const serverData = document.getElementById("server-data");
      const disableDatesLibur = JSON.parse(serverData.dataset.disableDatesLibur);
      const sisaLibur = parseInt(serverData.dataset.liburTersisa, 10);
      const sisaCuti = parseInt(serverData.dataset.cutiTersisa, 10);
      const sisaCutiLain = parseInt(serverData.dataset.cutilainTersisa, 10);
      
      if (sisaLibur > 0) {
        createDatePickers(sisaLibur, 'tanggalLiburContainer', 'tanggalLiburContainer', disableDatesLibur, true);
        const jumlahLiburInput = document.getElementById('jumlahLibur');
        if (jumlahLiburInput) {
           jumlahLiburInput.style.display = 'none';
        }
      }

      function setupCutiInput(inputId, containerId, maxJatah) {
          const inputElement = document.getElementById(inputId);
          if (!inputElement) return;

          inputElement.addEventListener('input', e => {
              let jumlahDiajukan = parseInt(e.target.value, 10);
              if (isNaN(jumlahDiajukan) || jumlahDiajukan < 0) {
                  jumlahDiajukan = 0;
              }

              if (jumlahDiajukan > maxJatah) {
                  showCustomModal({
                      type: 'warning',
                      title: 'Peringatan',
                      message: `Jumlah pengajuan (${jumlahDiajukan}) melebihi sisa jatah (${maxJatah}).`,
                      confirmText: 'Mengerti',
                      showCancel: false
                  });
                  e.target.value = '';
                  createDatePickers(0, containerId, containerId, []);
              } else {
                  createDatePickers(jumlahDiajukan, containerId, containerId, []);
              }
          });
      }

      setupCutiInput('jumlahCuti', 'tanggalCutiContainer', sisaCuti);
      setupCutiInput('jumlahCutiLain', 'tanggalCutiLainContainer', sisaCutiLain);
      
      const dropdownToggle = document.getElementById('userDropdownToggle');
      const dropdownMenu = document.getElementById('userDropdownMenu');
      const logoutLink = document.getElementById('logoutLink');

      dropdownToggle.addEventListener('click', function(e) {
        e.preventDefault();
        dropdownMenu.classList.toggle('show');
      });

      document.addEventListener('click', function(e) {
        if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownMenu.classList.remove('show');
        }
      });

      logoutLink.addEventListener('click', function(e) {
        e.preventDefault();
        showCustomModal({
          type: 'logout',
          title: 'Konfirmasi Logout',
          message: 'Apakah Anda yakin ingin keluar dari sistem?',
          confirmText: 'Ya, Logout',
          onConfirm: () => window.location.href = '/logout'
        });
      });
      
      const messageContainer = document.getElementById('server-message-data');
      if (messageContainer) {
          const status = messageContainer.dataset.status;
          const message = messageContainer.innerHTML;
          
          showCustomModal({
            type: status === 'sukses' ? 'success' : 'error',
            title: status === 'sukses' ? 'Pengajuan Berhasil' : 'Terjadi Kesalahan',
            message: message, 
            confirmText: 'OK',
            showCancel: false
          });
      }
      
      document.getElementById('customModal').addEventListener('click', (e) => (e.target === e.currentTarget) && hideCustomModal());
      document.addEventListener('keydown', (e) => (e.key === 'Escape') && hideCustomModal());
    });
  </script>
</body>
</html>