<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Jadwal Pegawai</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    .navbar { background: #007BFF; color: #fff; padding: 10px 20px; display: flex; }
    .container { padding: 20px; }
    table { border-collapse: collapse; font-size: 14px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    th { background: #eee; position: sticky; top: 0; }
    .left-table-wrapper, .right-table-wrapper { max-height: 500px; overflow: auto; }
    select, button { margin: 10px 5px; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }
    select { background: #fff; color: #000; border: 1px solid #ccc; font-weight: normal; }
    button { background: #28a745; color: #fff; }
    #message { margin-top: 10px; font-weight: bold; }
    #message.success { color: #28a745; }
    #message.fail { color: #dc3545; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="navbar">
    <div>Dashboard Admin</div>
  </div>
  <div class="container">
    <div>
      <label for="bulan">Bulan: </label>
      <select id="bulan" onchange="handleBulanChange()">
        <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
        <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
        <option value="7" selected>Juli</option><option value="8">Agustus</option><option value="9">September</option>
        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
      </select>
      
      <label style="margin-left: 15px; font-weight: normal; cursor: pointer;">
        <input type="checkbox" id="check-all" onchange="toggleAllChecks(this)" style="vertical-align: middle;">
        Centang Semua Action
      </label>
      <span id="message"></span>
    </div>
    <div style="display:flex; gap:20px; margin-top:15px;">
      <div class="left-table-wrapper">
        <table id="left-table">
          <thead>
            <tr>
              <th>NIP</th>
              <th>Nama</th>
              <th>Jenis</th>
              <th>Request</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="left-body"></tbody>
        </table>
      </div>
      <div class="right-table-wrapper">
        <table id="right-table">
          <thead id="right-head"></thead>
          <tbody id="right-body"></tbody>
        </table>
      </div>
    </div>
    <div style="margin-top:15px;">
      <button onclick="generateJadwal()">Generate Jadwal</button>
      <button onclick="downloadExcel()" style="background:#6c757d;">Download Excel</button>
      <button id="pushToSheet" style="background:#0018F9;">Apply Jadwal Ke Sheet</button>

    </div>
  </div>

  <script>
    let pegawaiTetap = [], dataPengajuan = [], pegawaiMap = {};
    let scheduleList = [];

    // =================================================================
    // IDE BARU: PETA WARNA TERPUSAT
    // =================================================================
    const scheduleColorMap = {
      // Kelompok P (Kuning & Oranye)
      'P6':  '#FFF9C4', // Kuning Pucat
      'P7':  '#FFF9C4',
      'P8':  '#FFF9C4',
      'P9':  '#FFF9C4',
      'P10': '#FFFF00', // Kuning Terang
      'P11': '#FFECB3', // Oranye Pucat
      
      // Kelompok S (Hijau & Biru)
      'S12':  '#C8E6C9', // Hijau Muda
      'SOCM': '#B2DFDB', // Teal Muda
      'SOC2': '#B2DFDB',
      'SOC6': '#B2DFDB',

      // Status Lain
      'Libur': '#FFCDD2', // Merah Muda
      'Cuti':  '#D1C4E9', // Ungu Muda
      'M':     '#E0E0E0',  // Abu-abu
    };

    function daysInMonth(month, year) {
      return new Date(year, month, 0).getDate();
    }

    function getTanggalBulan(bulan) {
      const yr = new Date().getFullYear();
      return Array.from(
        { length: daysInMonth(bulan, yr) },
        (_, i) => `${String(i+1).padStart(2,'0')}-${String(bulan).padStart(2,'0')}-${yr}`
      );
    }

    function loadPegawai() {
      google.script.run.withSuccessHandler(list => {
        pegawaiTetap = Array.isArray(list) ? list : [];
        pegawaiTetap.forEach(p => pegawaiMap[p.NIP] = p.Nama);
        renderRightTable();
        fetchPengajuan();
      }).getPegawai();
    }

    function fetchPengajuan() {
      google.script.run.withSuccessHandler(list => {
        dataPengajuan = (Array.isArray(list) ? list : []).map(p => ({
          ...p, nama: pegawaiMap[p.nip] || ''
        }));
        renderLeftTable();
        markSelectedDates();
      }).getPengajuan();
    }

    function renderLeftTable() {
      const tbody = document.getElementById('left-body');
      tbody.innerHTML = '';
      if (!dataPengajuan.length) {
        tbody.innerHTML = '<tr><td colspan="6">Tidak ada data pengajuan</td></tr>';
        return;
      }
      dataPengajuan.forEach((p,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nip}</td>
          <td>${p.nama}</td>
          <td>${p.jenis}</td>
          <td>${p.request.join(', ')}</td>
          <td>${p.status}</td>
          <td><input type="checkbox" class="pengajuan-check" data-idx="${i}"></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderRightTable() {
      const month = +document.getElementById('bulan').value;
      const days  = getTanggalBulan(month);
      const thead = document.getElementById('right-head');
      const tbody = document.getElementById('right-body');

      thead.innerHTML = `<tr>
        <th>NIP</th><th>Nama</th>` +
        days.map(d => `<th>${parseInt(d.split('-')[0],10)}</th>`).join('') +
      `</tr>`;

      tbody.innerHTML = '';
      pegawaiTetap.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.NIP}</td><td>${p.Nama}</td>` +
          days.map(d => `<td data-nip="${p.NIP}" data-tgl="${d}"></td>`).join('');
        tbody.appendChild(tr);
      });
      markSelectedDates();
    }

    function markSelectedDates() {
      document.querySelectorAll('#right-body td[data-tgl]').forEach(td => {
        td.textContent = '';
        td.style.backgroundColor = '';
      });
      document.querySelectorAll('.pengajuan-check:checked').forEach(ch => {
        const p = dataPengajuan[+ch.dataset.idx];
        const isLibur = p.jenis.toLowerCase() === 'libur';
        const sym = isLibur ? 'L' : 'C';
        const bg  = isLibur ? scheduleColorMap['Libur'] : scheduleColorMap['Cuti'];
        p.request.forEach(tgl => {
          const cell = document.querySelector(
            `td[data-nip="${p.nip}"][data-tgl="${tgl}"]`
          );
          if (cell) {
            cell.textContent = sym;
            cell.style.backgroundColor = bg;
          }
        });
      });
    }

    document.getElementById('left-body').addEventListener('click', e => {
      if (e.target.matches('.pengajuan-check')) markSelectedDates();
    });

    function handleBulanChange() {
      renderRightTable();
      fetchPengajuan();
    }
    
    function toggleAllChecks(masterCheckbox) {
      const isChecked = masterCheckbox.checked;
      document.querySelectorAll('.pengajuan-check').forEach(checkbox => {
        checkbox.checked = isChecked;
      });
      markSelectedDates();
    }
    
    // ────────────────────────────────────────────────────────────────────────────
    // SCHEDULING INTEGRATION
    // ────────────────────────────────────────────────────────────────────────────

    function generateJadwal() {
  const month = +document.getElementById('bulan').value;
  const year = new Date().getFullYear();
  const requests = [];

  document.querySelectorAll('.pengajuan-check:checked').forEach(ch => {
    const p = dataPengajuan[+ch.dataset.idx];
    p.request.forEach(tgl => {
      const [dd, mm, yyyy] = tgl.split('-');
      requests.push({
        nip:     Number(p.nip),
        jenis:   p.jenis,
        tanggal: `${yyyy}-${mm}-${dd}`
      });
    });
  });

  if (!requests.length) {
    return alert('Pilih minimal satu pengajuan sebelum generate.');
  }

  // Tampilkan loading atau nonaktifkan tombol untuk mencegah klik ganda
  alert('Mengambil data tanggal merah dan memulai proses generate...');

  // Panggil fungsi backend untuk mengambil tanggal merah
  google.script.run
    .withSuccessHandler(function(tanggalMerahDariBackend) {
      // Kode fetch SEKARANG ADA DI DALAM withSuccessHandler
      
      const holidays = tanggalMerahDariBackend; // Gunakan hasil dari backend
       console.log("Permintaan yang akan dikirim ke API generate-schedule:");
      console.log(JSON.stringify({
        year,
        month,
        requests,
        public_holidays: holidays
      }, null, 2));
      fetch('http://localhost:5001/generate-schedule', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ year, month, requests, public_holidays:holidays }) // 'holidays' sudah terisi
      })
      .then(res => { if (!res.ok) throw new Error(res.statusText); return res.json(); })
      .then(data => {
        alert(data.message || 'Proses pembuatan jadwal dimulai.');
        if (data.status_check_url) pollStatus(data.status_check_url);
      })
      .catch(err => {
        console.error(err);
        alert('Gagal mengirim permintaan: ' + err.message);
      });
    })
    .withFailureHandler(function(err) {
        alert("Gagal mengambil data tanggal merah dari Google Sheets: " + err.message);
    })
    .getTanggalMerah(); // Nama fungsi backend yang kita buat
}

    function pollStatus(checkUrl) {
      const interval = 60000, maxTries = 40;
      let tries = 0;
      const msgEl = document.getElementById('message');
      msgEl.textContent = 'Sedang memproses jadwal…';

      const timer = setInterval(() => {
        tries++;
        fetch(checkUrl)
          .then(res => { if (!res.ok) throw new Error(res.statusText); return res.json(); })
          .then(json => {
            console.log(json);
            if (json.state === 'SUCCESS' && Array.isArray(json.result)) {
              clearInterval(timer);
              msgEl.textContent = `✅ Jadwal siap setelah ${tries} percobaan.`;
              msgEl.className = 'success';
              scheduleList = json.result.map(e => e.result);
              applyScheduleToMainTable(scheduleList[0].schedule);
            } 
            else if (tries >= maxTries) {
              clearInterval(timer);
              msgEl.textContent = '❌ Batas polling terlampaui.';
              msgEl.className = 'fail';
            }
          })
          .catch(() => {
            if (tries >= maxTries) {
              clearInterval(timer);
              msgEl.textContent = '❌ Polling gagal.';
              msgEl.className = 'fail';
            }
          });
      }, interval);
    }

    // =================================================================
    // IDE BARU: FUNGSI DIPERBARUI UNTUK MEWARNAI JADWAL DI LAYAR
    // =================================================================
    function applyScheduleToMainTable(scheduleData) {
  // ① clear previous auto‐shifts
  document.querySelectorAll('.auto-shift').forEach(c => {
    c.textContent = '';
    c.style.backgroundColor = '';
    c.classList.remove('auto-shift');
  });
  // ② re‑apply any manual selections (L/C)
  markSelectedDates();

  const month = String(document.getElementById('bulan').value).padStart(2,'0');
  const year  = new Date().getFullYear();

  Object.entries(scheduleData).forEach(([nip, shifts]) => {
    shifts.forEach((shift, idx) => {
      const day   = String(idx+1).padStart(2,'0');
      const ddmmy = `${day}-${month}-${year}`;
      const cell  = document.querySelector(`td[data-nip="${nip}"][data-tgl="${ddmmy}"]`);

      if (cell && !cell.textContent) {
        // decide what to show
        let display;
        if      (shift.toLowerCase() === 'libur') display = 'L';
        else if (shift.toLowerCase() === 'cuti')  display = 'C';
        else                                      display = shift;

        cell.textContent   = display;
        cell.classList.add('auto-shift');

        // background color mapping (you already have scheduleColorMap)
        const color = scheduleColorMap[shift];
        if (color) {
          cell.style.backgroundColor = color;
        } else if (shift && shift !== '-') {
          cell.style.backgroundColor = '#e8f0fe'; // default
        }
      }
    });
  });
}


    // =================================================================
    // IDE BARU: FUNGSI DIPERBARUI UNTUK DOWNLOAD EXCEL BERWARNA
    // =================================================================
// GANTI FUNGSI LAMA ANDA DENGAN VERSI BARU YANG LEBIH SAKTI INI
    function downloadExcel() {
        const tbl = document.getElementById('right-table');
        if (!tbl) return alert('Tabel jadwal tidak ditemukan.');

        // 1. Ambil header dan isi tabel secara terpisah
        const header = Array.from(tbl.querySelectorAll('thead tr th')).map(th => th.textContent.trim());
        const bodyRows = Array.from(tbl.querySelectorAll('tbody tr'));
        
        // 2. Buat "cetakan" data (array of arrays) sambil menyisipkan instruksi warna
        const sheetData = [header]; // Mulai dengan header
        
        bodyRows.forEach(tr => {
            const rowData = Array.from(tr.querySelectorAll('td')).map(td => {
                const cellValue = td.textContent.trim();
                
                // Buat objek sel dasar
                const cellObject = { v: cellValue, t: 's' }; // v = value, t = type 'string'

                // Cek di "Peta Warna" kita
                const colorHex = scheduleColorMap[cellValue];
                if (colorHex) {
                    // Jika ada, tambahkan properti style (s) ke objek sel
                    cellObject.s = {
                        fill: {
                            patternType: "solid",
                            fgColor: { rgb: colorHex.replace('#', '') } // Hapus '#' dari hex
                        }
                    };
                }
                return cellObject;
            });
            sheetData.push(rowData);
        });

        // 3. Buat Workbook dan Worksheet dari "cetakan" data yang sudah lengkap
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(sheetData);

        // 4. (Bonus!) Atur lebar kolom agar rapi secara otomatis
        const colWidths = header.map((_, i) => ({
          wch: Math.max(
            ...sheetData.map(row => row[i] ? String(row[i].v).length : 0),
            header[i].length
          ) + 2 // Tambah sedikit spasi
        }));
        ws['!cols'] = colWidths;
        
        // 5. Simpan dan download file
        const monthName = document.getElementById('bulan').options[document.getElementById('bulan').selectedIndex].text;
        const year = new Date().getFullYear();
        XLSX.utils.book_append_sheet(wb, ws, 'Jadwal');
        XLSX.writeFile(wb, `Jadwal ${monthName} ${year}.xlsx`);
    }

   
    document.getElementById('pushToSheet')
  .addEventListener('click', () => {
    const tbl = document.getElementById('right-table');
    if (!tbl) return alert('Jadwal belum ada. Generate dulu.');

    // ① build a 2D array from every <tr>
    const allRows = Array.from(tbl.querySelectorAll('tr'))
      .map(tr => Array.from(tr.children).map(cell => cell.textContent.trim()));

    // ② drop the first (header) and last row
    //     slice(startInclusive, endExclusive)
    const bodyRows = allRows.slice(1, allRows.length - 1);

    google.script.run
      .withSuccessHandler(res => {
        if (res.success) {
          alert('✅ Jadwal berhasil ditulis ke sheet “JadwalOutput”.');
        } else {
          alert('❌ Gagal: ' + res.message);
        }
      })
      .withFailureHandler(err => {
        alert('❌ Server error: ' + err.message);
      })
      .writeScheduleToSheet(bodyRows);
  });


    document.addEventListener('DOMContentLoaded', () => {
      loadPegawai();
    });
  </script>
</body>
</html>
